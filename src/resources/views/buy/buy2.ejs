<section id="intro" class="intro-short-small">
    <div class="intro-container ">
        <div id="introCarousel" class="carousel slide carousel-fade" data-ride="carousel">

            <div class="carousel-inner" role="listbox">

                <div class="carousel-item active">
                    <div class="carousel-background"><img src="/img/pr.jpg" alt="" class="w-100"></div>
                    <div class="carousel-container">
                        <div class="carousel-content content-center">
                            <div class="container">
                                <div class="row justify-content-center">
                                    <div class="col-12 col-xl-6 col-lg-8 col-md-10">
                                        <div class="user-profile text-center text-white mt-5">
                                            <div class="user-info">
                                                <h3 class="fs-150 mb-0 text-white">Mua <%=coin %> từ đại lý <%=
                                                            agency.name %>
                                                </h3>
                                            </div>
                                            <div class="kt-wizard-v3 mb-5 mt-4 pt-2">
                                                <div class="kt-wizard-v3__nav">
                                                    <div class="kt-wizard-v3__nav-line"></div>
                                                    <div class="kt-wizard-v3__nav-items">

                                                        <div id="ctl11_DivChecking" class="kt-wizard-v3__nav-item"
                                                            data-ktwizard-state="done">
                                                            <span>1</span>
                                                            <i class="fa fa-check"></i>
                                                        </div>
                                                        <div id="ctl11_DivPending" class="kt-wizard-v3__nav-item"
                                                            data-ktwizard-state="done">
                                                            <span>2</span>
                                                            <i class="fa fa-check"></i>
                                                        </div>
                                                        <div id="ctl11_DivPending" class="kt-wizard-v3__nav-item">
                                                            <span>3</span>
                                                            <i class="fa fa-check"></i>
                                                        </div>
                                                        <div id="ctl11_DivPending" class="kt-wizard-v3__nav-item">
                                                            <span>4</span>
                                                            <i class="fa fa-check"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

        </div>

    </div>
</section>
<section id="coin-info" class="pt-5">

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-6 col-lg-8 col-md-10">
                <div class="card shadow-sm mb-5 border-0">
                    <div class="card-header border-0 py-3 d-flex flex-row align-items-center justify-content-between">
                        <h5 class="m-0 font-weight-bold text-primary">
                            2. Số lượng và địa chỉ ví
                        </h5>
                    </div>

                    <div class="card-body border-0 mini-col">
                        <div class="row">
                            <div class="col-12 col-xl-6 col-lg-6 col-md-12">
                                <div class="form-group">
                                    <label for="" class="font-weight-500">Số lượng mua</label>
                                    <div class="input-group mb-0">
                                        <input type="number" class="form-control" value="" id="address_value">
                                        <div class="input-group-append">
                                            <span class="input-group-text" id="coin_value">
                                                <%= coin %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-6 col-lg-6 col-md-12">
                                <div class="form-group mini-col">
                                    <label for="" class="font-weight-500">Giá mua</label>
                                    <div class="input-group mb-0">
                                        <input type="text" id="coinPrice" class="form-control"
                                            value="<%= Intl.NumberFormat().format(rate) %>" readonly="">
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                VND
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="text-center fs-110 font-weight-bold mb-2 mt-2">
                                    Số tiền bạn trả: <span class="font-weight-bold text-success" id="sumPrice">
                                    </span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group mini-col mb-2">
                                    <label for="" class="font-weight-500">Địa chỉ ví của bạn</label>
                                    <input type="text" class="form-control" id="address_wallet" >
                                </div>
                                <span id="error"></span>
                            </div>

                        </div>
                    </div>

                    <div class="card-footer border-0">
                        <!--<button class="btn btn-secondary">
                            <i class="las la-arrow-left"></i>
                            Quay lại
                        </button>
                        <button class="btn btn-primary float-right">
                            <i class="las la-arrow-right"></i>
                            Tiếp tục
                        </button>-->
                        <a href="/transaction/buy?step=1" class="btn btn-secondary">
                            <i class="las la-arrow-left"></i>
                            Quay lại
                        </a>
                        <a href="/transaction/buy?step=3&coin=<%=coin%>" class="btn btn-primary float-right"
                            id="buy_continue">
                            Tiếp tục
                            <i class="las la-arrow-right"></i>
                        </a>

                    </div>

                </div>
            </div>
        </div>
    </div>
    <span id="agentId" style="display: none">
        <%= agency.agencyId %>
    </span>
</section>
<script>
    // take value of form
    var listCoin = {
        btc: 1,
        eth: 3,
        bch: 4,
        ltc: 5,
        usdt: 6,
        xrp: 8,
        xlm: 10,
        trx: 11,
        vndt: 12,
        usdf: 14,
    }

    var coinCode = document.getElementById('coin_value').innerText;
    var agencyId = document.getElementById('agentId').innerText;
    var typeCoin;
    if (listCoin.hasOwnProperty(coinCode.toLowerCase())) {
        typeCoin = listCoin[coinCode.toLowerCase()];
    }

    const queryString = window.location.href;
    var type, walletCode, user
    if (queryString.includes('buy')) {
        type = 2
    } else if (queryString.includes('sell')) {
        type = 1
    }

    // element for html
    address_wallet = document.getElementById('address_wallet');
    address_val = document.getElementById('address_value');

    sumPriceEle = document.getElementById('sumPrice');
    errorEle = document.getElementById('error');

    buyContinue = document.getElementById('buy_continue')

    // check Error
    function checkError() {
        if (quantityInvalid || addressInvalid) {
            buyContinue.classList.add('disabled');
        }else{
            buyContinue.classList.remove('disabled');
        }
        return;  
    }

    // set info for html
    sumPriceEle.innerHTML = 0
    buyContinue.classList.add('disabled');
    var quantityInvalid = true;
    var addressInvalid = true;
    address_val.addEventListener('input', function () {        
        var coinPrice = parseFloat('<%=rate%>');
        quantityInvalid = true;
        var quantity = address_val.value;
        if (quantity == undefined || quantity == "") {
            toastr_error('Vui lòng nhập số lượng mua','');
            return;
        }
        if (parseFloat(quantity) < 0) {
            toastr_error('Số lượng không hợp lệ', '');
            return;
        }
        sumPrice = parseFloat(quantity) * parseFloat(coinPrice);
        sumPriceEle.innerHTML = Intl.NumberFormat().format(sumPrice);
        quantityInvalid = false;
        checkError();
    })

    address_wallet.addEventListener('blur', function () {      
        addressInvalid = true;
        if (this.value == undefined || this.value == "") {
            toastr_error('Vui lòng nhập địa chỉ nhận coin', '');
            return;
        }
        var cur = '<%= coin %>';
        if ("BTC TRX USDF XENG VNDT XRP".indexOf(cur.toUpperCase()) > -1 && this.value.length != 34) {
            toastr_error('Địa chỉ nhận không hợp lệ', '');
            return;
        }
        if ("ETH USDT".indexOf(cur.toUpperCase()) > -1 && this.value.length != 42) {
            toastr_error('Địa chỉ nhận không hợp lệ', '');
            return;
        }
        if ("XLM".indexOf(cur.toUpperCase()) > -1 && this.value.length != 56) {
            toastr_error('Địa chỉ nhận không hợp lệ', '');
            return;
        }

        user = {
            currencyCode: typeCoin,
            orderType: type,
            agentId: agencyId,
            receiveAddress: this.value,
            quantity: address_val.value,
            sumPrice: parseFloat(address_val.value) * parseFloat('<%=rate%>'),
            amountValue: '<%=rate%>',
        }
        // save to localStorage
        localStorage.setItem('user', JSON.stringify(user));
        addressInvalid = false;
        checkError();
    });
</script>